{% extends "base.html" %}

{% block title %}My Boards - Trello Lite{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">My Boards</h1>
</div>

{# 1. Vue Component for Creating a New Board #}
<div id="new-board-app" class="card mb-5 border-primary shadow">
    <div class="card-body">
        <h5 class="card-title text-primary">üöÄ Start a New Project</h5>
        
        <form @submit.prevent="createBoard">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> 
            
            <input type="text" 
                   v-model="newBoardTitle"
                   class="form-control form-control-lg mb-3" 
                   placeholder="Enter a board name (e.g., Q4 Project Plan)" 
                   required
                   :disabled="isSubmitting"> 
            
            <button type="submit" class="btn btn-primary w-100" :disabled="isSubmitting">
    <span v-if="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    <template v-if="isSubmitting">Creating...</template>
    <template v-else>Create Board</template>
</button>
        </form>
    </div>
</div>

<hr>

{# 2. Loop and Display Existing Boards #}
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% if boards %}
        {% for board in boards %}
        {# ‚úÖ ADD THIS CHECK: Skip any null or corrupted board objects #}
        {% if board %} 
        <div class="col">
            <div class="card h-100 shadow-sm board-card board-card-primary">
                <div class="card-body">
                    {# Link to the specific board's detailed view #}
                    <h5 class="card-title">
                        <a href="{{ url_for('view_board', board_id=board.id) }}" class="text-decoration-none">
                            {{ board.title }}
                        </a>
                    </h5>
                    <p class="card-text text-muted small">{{ board.lists|length }} Lists</p>
                </div>
                <div class="card-footer bg-transparent border-top-0 d-flex justify-content-end">
                    {# ... snip ... #}
                {# Use a POST form for deletion, which is safer than a GET link #}
                <form method="POST" action="{{ url_for('delete_board', board_id=board.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" 
                    class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('Are you sure you want to delete the board: {{ board.title }}? This cannot be undone.')">Delete</button>
                </form>
            </div>
            </div>
        </div>
    {% endif %}
    {% endfor %}
{% else %}
<div class="col-12">
    <div class="alert alert-info" role="alert">
        You don't have any boards yet. Create one above!
    </div>
</div>
{% endif %}  {# ‚¨ÖÔ∏è ADD THIS: Closes the {% if boards %} block #}
</div>
{% endblock %}
{% block scripts %}
<script>
    // This value is rendered by the server before the page loads
    const CSRF_TOKEN = "{{ csrf_token() }}"; 
</script>

<script>
    const { createApp, ref } = Vue;

    createApp({
        setup() {
            // Data properties
            const newBoardTitle = ref('');
            const isSubmitting = ref(false);
            
            // NOTE: The old logic to read the token from the DOM is now REMOVED.

            // Method to handle form submission
            async function createBoard() {
                if (!newBoardTitle.value.trim()) return;

                isSubmitting.value = true;

                // 1. Create FormData for Flask compatibility
                const formData = new FormData();
                formData.append('title', newBoardTitle.value);
                // üîë Use the new globally injected token
                formData.append('csrf_token', CSRF_TOKEN); 
                
                try {
                    const response = await fetch("{{ url_for('new_board') }}", {
                        method: 'POST',
                        // Set a custom header for Flask to recognize an AJAX request
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData // Send the data as FormData
                    });

                    // Check if the submission was successful
                    if (response.ok) {
                        const data = await response.json();
                        
                        newBoardTitle.value = '';
                        // Reload the page to see the new board (as intended for this demo)
                        window.location.reload(); 

                    } else {
                        const errorData = await response.json();
                        // Display the specific error message from the Flask JSON response
                        alert(`Error creating board: ${errorData.message}`); 
                    }

                } catch (error) {
                    console.error('Network or processing error:', error);
                    // This error now only catches network issues, not Flask validation errors
                    alert('A critical network error occurred while submitting the board.'); 
                } finally {
                    isSubmitting.value = false;
                }
            }

            return {
                newBoardTitle,
                isSubmitting,
                // csrfToken is removed from here
                createBoard
            };
        }
    }).mount('#new-board-app'); // Mount the app to the new board form element
</script>
{% endblock %}